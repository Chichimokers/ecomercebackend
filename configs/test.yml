name: CI Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-test:
    runs-on: self-hosted
    steps:
      # Clonar repositorio del backend
      - name: Clonar el repositorio backend
        uses: actions/checkout@v3

      # Clonar repositorio del frontend
      - name: Clonar repositorio frontend
        uses: actions/checkout@v3
        with:
          repository: tu-usuario/repositorio-frontend  # Cambiar por tu repo real
          path: frontend
          token: ${{ secrets.GITHUB_TOKEN }}  # Necesario si el repo es privado

      # Configurar Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22.2.0

      # Instalación de dependencias globales
      - name: Instalar stripe
        run: npm install stripe@17.4.0

      - name: Instalar dotenv cli
        run: npm install -g dotenv-cli

      - name: Instalar cli pm2
        run: npm install -g pm2

      # Frontend: Instalar dependencias y hacer build
      - name: Build del frontend
        working-directory: ./frontend
        run: |
          npm install
          npm run build  # Asegúrate que este comando genera los archivos estáticos

      # Copiar build del frontend a carpeta public del backend
      - name: Mover archivos del frontend
        run: |
          mkdir -p backend/public  # Crear carpeta si no existe
          cp -r frontend/dist/* backend/public/  # Ajusta 'dist' según tu estructura

      # Backend: Instalar dependencias
      - name: Instalar deps del backend
        working-directory: ./backend
        run: npm install --verbose

      # Iniciar aplicación
      - name: Iniciar la aplicación
        working-directory: ./backend
        run: pm2 restart esakiback || pm2 start npm --name "esakiback" -- run start:prods7